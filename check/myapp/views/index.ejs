<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>
        刷卡签到记录
    </title>
    <link rel='stylesheet' href='/css/layui.css' />
</head>

<body>
    <div class="layui-layout layui-layout-admin">
        <div class="layui-nav layui-header header header-demo" style="height: 100px" lay-bar="disabled">
            <div class="layui-fluid">
                <div class="layui-nav-item" style="position:absolute;top:17px;right:30px">
                    <i class="layui-icon layui-icon-user" style="font-size: 30px; color: #056da9;"></i>
                    <label name="username" id="username">普通用户</label>
                    <button type="button" class="layui-btn layui-btn-radius layui-btn-sm" name="login"
                        id="login">管理员登录</button>
                    <button type="button" class="layui-btn layui-btn-radius layui-btn-sm" name="quit"
                        id="quit">退出登录</button>
                </div>

                <div class="layui-nav-item">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 17px;">
                        <legend>
                            <i class="layui-icon layui-icon-release" style="font-size: 30px; color: #056da9;"></i>
                            刷卡签到记录   ╭(●｀∀´●)╯╰(●’◡’●)╮
                        </legend>
                    </fieldset>
                </div>
            </div>
        </div>
        <div class="layui-container">
            <div style="padding: 50px;"></div>
            <div class="layui-row">
                <div class="layui-tab layui-tab-brief" lay-filter="tab1">
                    <ul class="layui-tab-title ">
                        <li class="layui-this" lay-id="111">签到记录</li>
                        <li lay-id="222"class="admin-only">学生管理</li>
                        <li lay-id="333"class="admin-only">刷卡机管理</li>
                        <li lay-id="444" id="tab4" name="tab4"class="admin-only">管理员账号管理</li>
                        <li lay-id="555"class="admin-only">数据库管理</li>
                    </ul>

                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <form class="layui-form" action="" id="timesearch_form" name="timesearch_form">
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="white-space: nowrap">签到截止时间</label>
                                        <div class="layui-input-inline" style="width: 300px;">
                                            <input type="text" class="layui-input" id="qdtime">
                                        </div>
                                    </div>
                                    <div class="layui-inline" style="float: right">
                                        <button class="layui-btn" lay-submit lay-filter="timeclear">
                                            清除截止时间
                                        </button>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="white-space: nowrap">日期时间范围</label>
                                        <div class="layui-input-inline" style="width: 300px;">
                                            <input type="text" class="layui-input" id="timerange" placeholder=" - ">
                                        </div>
                                    </div>
                                    <div class="layui-inline" style="float: right">
                                        <button id="chartshow" class="layui-btn layui-btn-primary layui-border-green"
                                            type="button" lay-filter="chartshow">迟到情况统计
                                        </button>
                                        <button class="layui-btn" lay-submit lay-filter="allsearch">
                                            显示全部
                                        </button>
                                    </div>
                                
                                </div>
                                
                            
                                <table class="layui-table" id="record" lay-filter="demot1">
                                </table>
                                <form class="layui-form" action="" id="rosearch_form" name="rosearch_form">
                                    <label class="layui-form-label">按教室查找</label>
                                        <div class="layui-input-inline" style="width: 300px;">
                                            <input type="text" class="layui-input" id="roinput" name="roinput">
                                        </div>
                                        <div class="layui-inline">
                                            <button class="layui-btn" lay-submit lay-filter="rosearch">
                                                <i class="layui-icon layui-icon-search"
                                                    style="font-size: 15px; color: #eeeeee;"></i>
                                                搜索
                                            </button>
                                            <button class="layui-btn" lay-submit lay-filter="allrosearch">
                                                显示全部
                                            </button>
                                        </div>
                            </form>
                                <table class="layui-table" id="room" lay-filter="demot1">
                                </table>

                            </form>
                        </div>

                        <div class="layui-tab-item">
                            <!-- 用户管理 -->
                            <form class="layui-form" action="" id="idsearch_form" name="idsearch_form">
                                <label class="layui-form-label">按学号查找</label>
                                <div class="layui-input-inline" style="width: 300px;">
                                    <input type="text" class="layui-input" id="idinput" name="idinput">
                                </div>
                                <div class="layui-inline">
                                    <button class="layui-btn" lay-submit lay-filter="idsearch">
                                        <i class="layui-icon layui-icon-search"
                                            style="font-size: 15px; color: #ffffff;"></i>
                                        搜索
                                    </button>
                                    <button class="layui-btn" lay-submit lay-filter="allidsearch">
                                        显示全部
                                    </button>
                                </div>
                    
                                <table class="layui-table" id="numbers" lay-filter="demot2">
                                </table>
                            </form>
                        </div>

                        <div class="layui-tab-item">
                            <!-- 刷卡机管理 -->
                            <form class="layui-form" action="" id="roomsearch_form" name="roomsearch_form">
                                <label class="layui-form-label">房间号查找</label>
                                <div class="layui-input-inline" style="width: 300px;">
                                    <input type="text" class="layui-input" id="roominput" name="roominput">
                                </div>
                                <div class="layui-inline">
                                    <button class="layui-btn" lay-submit lay-filter="roomsearch">
                                        <i class="layui-icon layui-icon-search"
                                            style="font-size: 15px; color: #ffffff;"></i>
                                        搜索
                                    </button>
                                    <button class="layui-btn" lay-submit lay-filter="allroomsearch">
                                        显示全部
                                    </button>
                                </div>
                                <table class="layui-table" id="rooms" lay-filter="demot3">
                                </table>
                            </form>
                        </div>

                        <div class="layui-tab-item">
                            <!-- 管理员账号管理 -->
                            <form class="layui-form" action="" id="adminsearch_form" name="adminsearch_form">
                                <label class="layui-form-label">管理员查找</label>
                                <div class="layui-input-inline" style="width: 300px;">
                                    <input type="text" class="layui-input" id="admininput" name="admininput">
                                </div>
                                <div class="layui-inline">
                                    <button class="layui-btn" lay-submit lay-filter="adminsearch">
                                        <i class="layui-icon layui-icon-search"
                                            style="font-size: 15px; color: #ffffff;"></i>
                                        搜索
                                    </button>
                                    <button class="layui-btn" lay-submit lay-filter="alladminsearch">
                                        显示全部
                                    </button>
                                </div>
                                <table class="layui-table" id="admins" lay-filter="demot4">
                                </table>
                            </form>
                        </div>

                        <div class="layui-tab-item">
                            <!-- 数据库管理 -->
                            <hr class="layui-hr">
                            <div class="layui-btn-container">
                                <button class="layui-btn layui-btn-danger layui-btn layui-btn-disabled" id="init"
                                    name="init" href="/db/init">初始化签到记录</button>
                            </div>
                            <div class="layui-btn-container">
                                <button id="btnn1" class="layui-btn layui-btn-warm" lay-filter="btnn1">添加新成员</button>
                            </div>
                            <div class="layui-btn-container">
                                <button id="btnn2" class="layui-btn layui-btn-warm" lay-filter="btnn2">添加新房间</button>
                            </div>
                            <div class="layui-btn-container">
                                <button id="btnn3" name="btnn3" class="layui-btn layui-btn-warm"
                                    lay-filter="btnn3">添加新管理员账号</button>
                            </div>

                        </div>

                    </div>
                </div>
            </div>

            <div class="layui-row layui-col-md3" style="width:400px;margin:0px auto;display:none;" id="chart">
                <canvas id="myChart"></canvas>
                <table lay-even lay-skin="nob" style="float: right">
                    <tbody>
                        <tr>
                            <td>正常：</td>
                            <td><label name="normalper" id="normalper" style="float: right"></label></td>
                        </tr>
                        <tr>
                            <td>迟到：</td>
                            <td><label name="lateper" id="lateper" style="float: right"></label></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="layui-row" id="insert_stu" style="display:none;">
            <div class="layui-col-md11">
                <form class="layui-form" id="insertstu" name="insertstu" action="">
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">学号：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="insertstuid" name="insertstuid" class="layui-input"
                                lay-verify="required|number|stuid" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">姓名：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="insertname" name="insertname" class="layui-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">卡号：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="insertcardid" name="insertcardid" class="layui-input"
                                lay-verify="number|cardid" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">类型：</label>
                        <div class="layui-input-block">
                            <select name="inserttype" lay-verify="required">
                                <option value=201>本科生</option>
                                <option value=204>教职工</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="formDemo1">提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="layui-row" id="insert_room" style="display:none;">
            <div class="layui-col-md11">
                <form class="layui-form" action="" id="insert2" name="insert2">
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">房间号：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="insertnum" name="insertnum" class="layui-input"
                                lay-verify="required|number|roomnum">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">mac：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="insertmac" name="insertmac" class="layui-input" lay-verify="mac">
                        </div>
                    </div>
                    <div class=" layui-form-item layui-row">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="formDemo2">提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="layui-row" id="insert_admin" style="display:none;">
            <div class="layui-col-md11">
                <form class="layui-form" action="" id="insert3" name="insert3">
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">账号名：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="insertusername" name="insertusername" class="layui-input"
                                lay-verify="required|username">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">密码：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="insertpassword" name="insertpassword" class="layui-input"
                                lay-verify="required">
                        </div>
                    </div>
                    <div class=" layui-form-item layui-row">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="formDemo3">提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="layui-row" id="login_form" style="display:none;">
            <div class="layui-col-md11">
                <form class="layui-form" action="" id="loginform" name="loginform">
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">用户名：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="usernameinput" name="usernameinput" class="layui-input"
                                lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">密码：</label>
                        <div class="layui-input-inline">
                            <input type="password" id="passwordinput" name="passwordinput" class="layui-input"
                                lay-verify="required">
                        </div>
                    </div>
                    <div class=" layui-form-item layui-row">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="formDemo4">提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="layui-row" id="adminedit_form" style="display:none;">
            <div class="layui-col-md11">
                <form class="layui-form" lay-filter="adminedit" action="" id="admineditform" name="admineditform">
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">用户名：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="newusername" name="newusername" class="layui-input"
                                lay-verify="required|newusername">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">旧密码：</label>
                        <div class="layui-input-inline">
                            <input type="password" id="oldpassword" name="oldpassword" class="layui-input"
                                lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row">
                        <label class="layui-form-label">新密码：</label>
                        <div class="layui-input-inline">
                            <input type="password" id="newpassword" name="newpassword" class="layui-input"
                                placeholder="若为空则不修改密码">
                        </div>
                    </div>
                    <div class=" layui-form-item layui-row">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="formDemo5">提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div style="width: 100%;text-align: center;margin: 0px auto; margin-bottom: 25px;">
            <i class="layui-icon layui-icon-praise" style="font-size: 30px; color: #056da9;"></i>
            Cu&Mu  (ฅ´ω`ฅ)
        </div>

    </div>

    <div id='barDemo' style='display:none'>
        <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" id="delete_btn" name="delete_btn" lay-event="del"
            style="display:inline-block">删除</a>
    </div>
    <div id='barDemo1' style='display:none'>
        <a class="layui-btn layui-btn-xs" lay-event="passwordchange">编辑</a>
    </div>
    </div>
    <script src="/layui.js"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
    <script src="https://cdn.bootcss.com/Chart.js/2.7.3/Chart.js"></script>
    <script>
        layui.use(['layer', 'element', 'table', 'jquery', 'form', 'laydate'], function () {
            var layer = layui.layer,
                element = layui.element,
                table = layui.table,
                form = layui.form,
                laydate = layui.laydate,
                returnMessage,
                $ = layui.jquery,
                ctx = document.getElementById('myChart').getContext('2d')
                ;

            $(function () {
                $('#qdtime').val(sessionStorage.getItem("qdtime"));
                $('#timerange').val(sessionStorage.getItem("timerange"));
                if ((sessionStorage.getItem("username") == null) || (sessionStorage.getItem("username") == "")) {
                    $("#init").hide();
                    $("#delete_btn").hide();
                    $("#quit").hide();
                    $("#tab4").hide();
                    $("#btnn3").hide();
                    $(".admin-only").hide();
                }
                else {
                    $("#init").show();
                    $("#delete_btn").show();
                    $('#username').html("您好，管理员 " + sessionStorage.getItem("username") + " ！");
                    $("#login").hide();
                    $("#quit").show();
                    $("#tab4").show();
                    $("#btnn3").show();
                    $(".admin-only").show();
                }
            });

            laydate.render({
                elem: '#qdtime'
                , type: 'time'
                , done: function (value, time) {
                    sessionStorage.setItem("qdtime", value);
                    $.ajax({
                        type: 'post',
                        url: '/api/qdtime',
                        data: {
                            time: value,
                            sign: 1
                        },
                        success: function (data) {
                            layer.msg('签到截止时间 ' + sessionStorage.getItem("qdtime") + ' 设置成功!');
                        }
                    });
                }
            });

            laydate.render({
                elem: '#timerange'
                , type: 'datetime'
                , range: true
                , done: function (value, date, endDate) {
                    sessionStorage.setItem("timerange", value);
                    value = value.split(" - ");
                    $.ajax({
                        type: 'post',
                        url: '/api/timesearch',
                        data: {
                            bt: value[0],
                            et: value[1],
                            sign: 1
                        },
                        success: function (data) {
                            top.location.href = '/#tab1=111';
                            top.location.reload();
                        }
                    });
                }
            });

            table.render({
                elem: '#record',
                //height: 300,
                url: '/api/recordlist',
                toolbar: true,
                title: '签到记录',
                totalRow: true,
                page: true,
                id: 'abc',
                limit: 10,
                limits: [5, 10, 20, 30],
                initSort: {
                    field: 'time',
                    type: 'desc'
                },
                parseData: function (res) { //res 即为原始返回的数据
                    var current_pages;
                    if (this.page === true) current_pages = 1;
                    else current_pages = this.page.curr;
                    var data = res.data.slice(this.limit * (current_pages - 1), this.limit * current_pages);
                    return {
                        "code": res.code,
                        "msg": res.msg,
                        "count": res.data.length,
                        "data": data
                    }
                },
                sort: true,
                cols: [
                    [{
                        field: 'stuid',
                        title: '学号',
                        width: 130,
                        sort: true
                    }, {
                        field: 'name',
                        title: '姓名',
                        width: 130
                    }, {
                        field: 'type',
                        title: '类型',
                        width: 130,
                        sort: true
                    }, {
                        field: 'room',
                        title: '教室',
                        width: 130
                    }, {
                        field: 'time',
                        title: '签到时间',
                        sort: true
                    }, {
                        field: 'qd',
                        title: '签到情况',
                        sort: true
                    }]
                ],
                done: function (res, curr, count) {
                    $.ajax({
                        type: 'get',
                        url: '/api/chartcheck',
                        data: {},
                        success: function (data) {
                            sessionStorage.setItem("late", data.la);
                            sessionStorage.setItem("normal", data.no);
                        }
                    });
                    $.each(res.data, function (index, item) {
                        if (item.qd == '迟到') {
                            $("#record").next().find('tbody tr[data-index="' + index +
                                '"]').css("background-color", "#FFA07A");
                        }
                    });
                }
            });
////////////////////////////////////////////////////////////////////////////////////////////////////////
            table.render({
                elem: '#room',
                //height: 300,
                url: '/api/rolist',
                id: 'room',
                toolbar: true,
                title: '对应房间',
                totalRow: true,
                page: true,
                limit: 10,
                limits: [5, 10, 20, 30],
                parseData: function (res) { //res 即为原始返回的数据
                    var current_pages;
                    if (this.page === true) current_pages = 1;
                    else current_pages = this.page.curr;
                    var data = res.data.slice(this.limit * (current_pages - 1), this.limit * current_pages);
                    return {
                        "code": res.code,
                        "msg": res.msg,
                        "count": res.data.length,
                        "data": data
                    }
                },
                cols: [
                [{
                        field: 'stuid',
                        title: '学号',
                        width: 130,
                        sort: true
                    }, {
                        field: 'name',
                        title: '姓名',
                        width: 130
                    }, {
                        field: 'type',
                        title: '类型',
                        width: 130,
                        sort: true
                    }, {
                        field: 'room',
                        title: '教室',
                        width: 130
                    }, {
                        field: 'time',
                        title: '签到时间',
                        sort: true
                    }, {
                        field: 'qd',
                        title: '签到情况',
                        sort: true
                    }]
                ],
                done: function (res, curr, count) {
                    $.ajax({
                        type: 'get',
                        url: '/api/chartcheck',
                        data: {},
                        success: function (data) {
                            sessionStorage.setItem("late", data.la);
                            sessionStorage.setItem("normal", data.no);
                        }
                    });
                    $.each(res.data, function (index, item) {
                        if (item.qd == '迟到') {
                            $("#record").next().find('tbody tr[data-index="' + index +
                                '"]').css("background-color", "#FFA07A");
                        }
                    });
                } 
                
            });
 ///////////////////////////////////////////////////////////////////////////////////////////////////
            table.render({
                elem: '#numbers',
                //height: 300,
                url: '/api/list',
                id: 'def',
                toolbar: true,
                title: '个人信息',
                totalRow: true,
                page: true,
                limit: 10,
                limits: [5, 10, 20, 30],
                parseData: function (res) { //res 即为原始返回的数据
                    var current_pages;
                    if (this.page === true) current_pages = 1;
                    else current_pages = this.page.curr;
                    var data = res.data.slice(this.limit * (current_pages - 1), this.limit * current_pages);
                    return {
                        "code": res.code,
                        "msg": res.msg,
                        "count": res.data.length,
                        "data": data
                    }
                },
                cols: [
                    [{
                        field: 'stuid',
                        title: '学号',
                        width: 130,
                        sort: true
                    }, {
                        field: 'name',
                        title: '姓名',
                        width: 130,
                        edit: true
                    }, {
                        field: 'cardid',
                        title: '卡号',
                        width: 250,
                        edit: true,
                        sort: true
                    }, {
                        field: 'type',
                        title: '类型',
                        width: 130,
                        sort: true
                    }, {
                        toolbar: '#barDemo',
                        fixed: 'right'
                    }]
                ]
            });

            table.render({
                elem: '#rooms',
                //height: 300,
                url: '/api/roomslist',
                id: 'def3',
                toolbar: true,
                title: '刷卡机房间信息',
                totalRow: true,
                page: true,
                limit: 10,
                limits: [5, 10, 20, 30],
                initSort: {
                    field: 'num'
                },
                parseData: function (res) { //res 即为原始返回的数据
                    var current_pages;
                    if (this.page === true) current_pages = 1;
                    else current_pages = this.page.curr;
                    var data = res.data.slice(this.limit * (current_pages - 1), this.limit * current_pages);
                    return {
                        "code": res.code,
                        "msg": res.msg,
                        "count": res.data.length,
                        "data": data
                    }
                },
                sort: true,
                cols: [
                    [{
                        field: 'num',
                        title: '房间号',
                        width: 130,
                        sort: true,
                        edit: true
                    },
                    {
                        field: 'mac',
                        title: '刷卡机',
                        width: 500,
                        edit: true
                    },
                    {
                        toolbar: '#barDemo',
                        fixed: 'right'
                    }]
                ]
            });

            table.render({
                elem: '#admins',
                //height: 300,
                url: '/api/adminslist',
                id: 'def4',
                toolbar: true,
                title: '刷卡机房间信息',
                totalRow: true,
                page: true,
                limit: 10,
                limits: [5, 10, 20, 30],
                parseData: function (res) { //res 即为原始返回的数据
                    var current_pages;
                    if (this.page === true) current_pages = 1;
                    else current_pages = this.page.curr;
                    var data = res.data.slice(this.limit * (current_pages - 1), this.limit * current_pages);
                    return {
                        "code": res.code,
                        "msg": res.msg,
                        "count": res.data.length,
                        "data": data
                    }
                },
                sort: true,
                cols: [
                    [{
                        field: 'username',
                        title: '管理员账号'
                    },
                    {
                        toolbar: '#barDemo1',
                        width: 100,
                        fixed: 'right'
                    },
                    {
                        toolbar: '#barDemo',
                        fixed: 'right'
                    }]
                ]
            });

            layid = location.hash.replace(/^#tab1=/, ''); //layid = 111,222,333,444
            element.tabChange('tab1', layid);

            form.verify({
                stuid: function (value, item) { //value：表单的值、item：表单的DOM对象
                    var checkResult = "";
                    $.ajax({
                        url: "/api/inputcheck0",
                        type: "POST",
                        data: {
                            n: 0,
                            idinput: value
                        },
                        async: false,
                        success: function (result) {
                            if ((result.sign == 0) && (value != "")) {
                                checkResult = "该学号已存在";
                            }
                        },
                        error: function () {
                        }
                    });
                    if (checkResult != '')
                        return checkResult;
                }
                , cardid: function (value, item) { //value：表单的值、item：表单的DOM对象
                    var checkResult = "";
                    $.ajax({
                        url: "/api/inputcheck1",
                        type: "POST",
                        data: {
                            n: 1,
                            idinput: value
                        },
                        async: false,
                        success: function (result) {
                            if (result.sign == 0) {
                                checkResult = "该卡号已存在";
                            }
                        }
                    });
                    if (checkResult != '')
                        return checkResult;
                }
                , roomnum: function (value, item) { //value：表单的值、item：表单的DOM对象
                    var checkResult = "";
                    $.ajax({
                        url: "/api/inputcheck2",
                        type: "POST",
                        data: {
                            idinput: value
                        },
                        async: false,
                        success: function (result) {
                            if (result.sign == 0) {
                                checkResult = "该房间已存在";
                            }
                        }
                    });
                    if (checkResult != '')
                        return checkResult;
                }
                , mac: function (value, item) { //value：表单的值、item：表单的DOM对象
                    var checkResult = "";
                    $.ajax({
                        url: "/api/inputcheck3",
                        type: "POST",
                        data: {
                            idinput: value
                        },
                        async: false,
                        success: function (result) {
                            if ((result.sign == 0) && (value != "")) {
                                checkResult = "该机器已存在于其他房间中";
                            }
                        }
                    });
                    if (checkResult != '')
                        return checkResult;
                }
                , username: function (value, item) { //value：表单的值、item：表单的DOM对象
                    var checkResult = "";
                    $.ajax({
                        url: "/api/inputcheck4",
                        type: "POST",
                        data: {
                            usernameinput: value
                        },
                        async: false,
                        success: function (result) {
                            if (result.sign == 0) {
                                checkResult = "该管理员账号已存在";
                            }
                        }
                    });
                    if (checkResult != '')
                        return checkResult;
                }
                , newusername: function (value, item) { //value：表单的值、item：表单的DOM对象
                    var checkResult = "";
                    $.ajax({
                        url: "/api/inputcheck4",
                        type: "POST",
                        data: {
                            usernameinput: value
                        },
                        async: false,
                        success: function (result) {
                            if ((result.sign == 0) && (value != sessionStorage.getItem("oldusername"))) {
                                checkResult = "该管理员账号已存在";
                            }
                        }
                    });
                    if (checkResult != '')
                        return checkResult;
                }
            });

            element.on('tab(tab1)', function () {
                location.hash = 'tab1=' + this.getAttribute('lay-id');
            });

            form.on('submit(allsearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/timesearch',
                    data: {
                        sign: 0
                    },
                    success: function (data) {
                        sessionStorage.setItem("timerange", "");
                        top.location.href = '/#tab1=111';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(timeclear)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/qdtime',
                    data: {
                        sign: 0
                    },
                    success: function (data) {
                        sessionStorage.setItem("qdtime", "");
                        top.location.href = '/#tab1=111';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(idsearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/idsearch',
                    data: {
                        sign: 1,
                        id: data.field.idinput
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=222';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(allidsearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/idsearch',
                    data: {
                        sign: 0
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=222';
                        top.location.reload();
                    }
                });
                return false;
            });
///////////////////////////////////////////////////////////////////
            form.on('submit(rosearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/rosearch',
                    data: {
                        sign: 1,
                        id: data.field.roinput
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=111';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(allrosearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/rosearch',
                    data: {
                        sign: 0
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=111';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(roomsearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/roomsearch',
                    data: {
                        sign: 1,
                        id: data.field.roominput
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=333';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(allroomsearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/roomsearch',
                    data: {
                        sign: 0
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=333';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(adminsearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/adminsearch',
                    data: {
                        sign: 1,
                        id: data.field.admininput
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=444';
                        top.location.reload();
                    }
                });
                return false;
            });

            form.on('submit(alladminsearch)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/adminsearch',
                    data: {
                        sign: 0
                    },
                    success: function (data) {
                        top.location.href = '/#tab1=444';
                        top.location.reload();
                    }
                });
                return false;
            });

            table.on('edit(demot2)', function (obj) {
  console.log('Edit event triggered.');
  $.ajax({
    url: '/db/update_users',
    method: 'post',
    data: obj.data,
    success: function (data) {
      if (data.status === 'success') {
        layer.msg('更新成功');
      } else {
        layer.msg('更新失败', { icon: 2 });

        // 更新失败时，进行提示，并重新编辑
        layer.tips('更新失败', obj.othis, { tips: 1 });

        // 将当前编辑的值重置为 oldValue
        var field = obj.field;
        var oldValue = obj.oldValue;
        obj.update({ [field]: oldValue }); // 使用对象属性的动态键名 [field]

        obj.reedit(); // 重新编辑 -- v2.8.0 新增
      }
    },
    error: function (xhr, status, error) {
      layer.msg('更新失败', { icon: 2 });

      // 更新失败时，进行提示，并重新编辑
      layer.tips('更新失败', obj.othis, { tips: 1 });

      // 将当前编辑的值重置为 oldValue
      var field = obj.field;
      var oldValue = obj.oldValue;
      obj.update({ [field]: oldValue }); // 使用对象属性的动态键名 [field]

      obj.reedit(); // 重新编辑 -- v2.8.0 新增
    }
  });
});

            table.on('edit(demot3)', function (obj) {
                $.ajax({
                    url: '/db/update_rooms',
                    method: 'post',
                    data: obj.data,
                    success: function (data) {
                        layer.msg('更新成功');
                    }
                });
            });
            

            table.on('tool(demot2)', function (obj) {
                var data = obj.data; //当前行的数据
                var layEvent = obj.event; //当前行的具体的哪个event

                if (layEvent === 'detail') {
                    layer.msg(JSON.stringify(data));
                } else if (layEvent === 'del') {
                    layer.confirm('真的要删除吗？', function (index) {
                        obj.del();
                        layer.close(index);
                        $.ajax({
                            url: '/db/delete_users',
                            method: 'post',
                            data: {
                                id: data.id,
                                stuid: data.stuid
                            },
                            success: function (data) {
                                table.reload('def');
                                layer.msg('删除成功！');
                            }
                        });
                    })
                }
            });

            table.on('tool(demot3)', function (obj) {
                var data = obj.data; //当前行的数据
                var layEvent = obj.event; //当前行的具体的哪个event

                if (layEvent === 'detail') {
                    layer.msg(JSON.stringify(data));
                } else if (layEvent === 'del') {
                    layer.confirm('真的要删除吗？', function (index) {
                        obj.del();
                        layer.close(index);
                        $.ajax({
                            url: '/db/delete_rooms',
                            method: 'post',
                            data: {
                                id: data.id,
                                num: data.num
                            },
                            success: function (data) {
                                table.reload('def3');
                                layer.msg('删除成功！');
                            }
                        });
                    })
                }
            });

            table.on('tool(demot4)', function (obj) {
                var data = obj.data; //当前行的数据
                var layEvent = obj.event; //当前行的具体的哪个event

                if (layEvent === 'detail') {
                    let data1 = {
                        id: data.id,
                        username: data.username,
                        password: md5(data.password)
                    }
                    layer.msg(JSON.stringify(data1));
                } else if (layEvent === 'del') {
                    layer.confirm('真的要删除吗？', function (index) {
                        obj.del();
                        layer.close(index);
                        $.ajax({
                            url: '/db/delete_admins',
                            method: 'post',
                            data: {
                                id: data.id,
                                username: data.username
                            },
                            success: function (data) {
                                table.reload('def4');
                                layer.msg('删除成功！');
                            }
                        });
                    })
                }
                else if (layEvent === 'passwordchange') {
                    width = $('#adminedit_form').outerWidth(true) + 150;
                    height = $('#adminedit_form').outerHeight(true) + 150;
                    sessionStorage.setItem("oldusername", data.username);
                    sessionStorage.setItem("id", data.id);
                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,
                        id: 5,
                        title: "管理员信息编辑",
                        area: [width + 'px', height + 'px'], //['30%', '65%'],
                        content: $("#adminedit_form").html()
                    });
                    form.val("adminedit", {
                        "newusername": data.username
                    });
                    form.render();
                }
            });

            $(document).on('click', '#btnn1', function () {
                width = $('#insert_stu').outerWidth(true) + 150;
                height = $('#insert_stu').outerHeight(true) + 150;
                layer.open({
                    //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                    type: 1,
                    id: 5,
                    title: "用户编辑",
                    area: [width + 'px', height + 'px'], //['30%', '65%'],
                    content: $("#insert_stu").html()
                });
                form.render();
            });

            $(document).on('click', '#btnn2', function () {
                width = $('#insert_room').outerWidth(true) + 150;
                height = $('#insert_room').outerHeight(true) + 150;
                layer.open({
                    type: 1,
                    id: 5,
                    title: "刷卡机编辑",
                    area: [width + 'px', height + 'px'], //['30%', '65%'],
                    content: $("#insert_room").html()
                });
                form.render();
            });

            $(document).on('click', '#btnn3', function () {
                width = $('#insert_admin').outerWidth(true) + 150;
                height = $('#insert_admin').outerHeight(true) + 150;
                layer.open({
                    type: 1,
                    id: 5,
                    title: "管理员账号编辑",
                    area: [width + 'px', height + 'px'], //['30%', '65%'],
                    content: $("#insert_admin").html()
                });
                form.render();
            });

            $(document).on('click', '#login', function () {
                width = $('#login_form').outerWidth(true) + 150;
                height = $('#login_form').outerHeight(true) + 150;
                layer.open({
                    //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                    type: 1,
                    id: 5,
                    title: "管理员登录",
                    area: [width + 'px', height + 'px'], //['30%', '65%'],
                    content: $("#login_form").html()
                });
                form.render();
            });

            $(document).on('click', '#chartshow', function () {
                var myChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['正常', '迟到'],
                        datasets: [{
                            label: '示例',
                            data: [sessionStorage.getItem("normal"), sessionStorage.getItem("late")],
                            backgroundColor: ['#58D3F7', '#FA8258'],
                            borderWidth: 1
                        }]
                    }
                })
                $('#normalper').html(((parseInt(sessionStorage.getItem("normal")) / (parseInt(sessionStorage.getItem("normal")) + parseInt(sessionStorage.getItem("late")))) * 100).toFixed(2) + '%');
                $('#lateper').html(((parseInt(sessionStorage.getItem("late")) / (parseInt(sessionStorage.getItem("normal")) + parseInt(sessionStorage.getItem("late")))) * 100).toFixed(2) + '%');
                layer.open({
                    type: 1,
                    id: 5,
                    title: "迟到情况统计",
                    area: ['35%', '50%'],
                    content: $("#chart")
                });
            });

            setInterval(function myrefresh() {
                $.ajax({
                    url: '/api/check',
                    method: 'get',
                    data: {},
                    success: function (data) {
                        if (data.flag1 == 0) {
                            sessionStorage.setItem("qdtime", "");
                            sessionStorage.setItem("timerange", "");
                            sessionStorage.setItem("username", "");
                        }
                        if (data.flag == 1) {
                            table.reload('abc');
                            layer.msg(data.id + ' 签到成功！');
                        }
                        else if (data.flag == 2) {
                            table.reload('abc');
                            layer.msg(data.id + ' 重复刷卡！');
                        }
                    },
                    error: function (data) {
                        alert("调用失败！");
                    }
                });
            }, 3000);

            form.on('submit(formDemo1)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/db/insert_user',
                    data: data.field,
                    success: function (data) {
                        if (data == 'ok') {
                            top.location.href = '/#tab1=222';
                            top.location.reload();
                            // layer.msg('添加成功！');
                        } else if (data == 'error') {
                            layer.msg('添加失败！');
                        }
                    }
                });
                return false; //禁止跳转，否则会提交两次，且页面会刷新
            });

            form.on('submit(formDemo2)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/db/insert_room',
                    data: data.field,
                    success: function (data) {
                        if (data == 'ok') {
                            top.location.href = '/#tab1=333';
                            top.location.reload();
                            // layer.msg('添加成功！');
                        } else if (data == 'error') {
                            layer.msg('添加失败！');
                        }
                    }
                });
                return false; //禁止跳转，否则会提交两次，且页面会刷新
            });

            form.on('submit(formDemo3)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/db/insert_admin',
                    data: data.field,
                    success: function (data) {
                        if (data == 'ok') {
                            top.location.href = '/#tab1=444';
                            top.location.reload();
                            // layer.msg('添加成功！');
                        } else if (data == 'error') {
                            layer.msg('添加失败！');
                        }
                    }
                });
                return false; //禁止跳转，否则会提交两次，且页面会刷新
            });

            form.on('submit(formDemo4)', function (data) {
                $.ajax({
                    type: 'post',
                    url: '/api/login',
                    data: data.field,
                    success: function (result) {
                        if (result.sign == 0) {
                            sessionStorage.setItem("username", data.field.usernameinput);
                            $("#init").show();
                            $("#delete_btn").show();
                            $('#username').html("您好，管理员 " + data.field.usernameinput + " ！");
                            $("#login").hide();
                            $("#quit").show();
                            $("#tab4").show();
                            $("#btnn3").show();
                            // layer.msg('管理员 ' + data.field.usernameinput + ' 登录成功!');
                            top.location.href = '/#tab1=111';
                            top.location.reload();
                        } else if (result.sign == 1) {
                            layer.msg('密码错误！');
                        }
                        else if (result.sign == 2) {
                            layer.msg('用户名错误！');
                        }
                    }
                });
                return false;
            });

            form.on('submit(formDemo5)', function (data) {
                $.ajax({
                    url: '/db/update_admins',
                    method: 'post',
                    data: {
                        id: sessionStorage.getItem("id"),
                        oldusername: sessionStorage.getItem("oldusername"),
                        newusername: data.field.newusername,
                        oldpassword: data.field.oldpassword,
                        newpassword: data.field.newpassword
                    },
                    success: function (data) {
                        if (data.sign == 0) {
                            top.location.href = '/#tab1=444';
                            top.location.reload();
                        } else if (data.sign == 1) {
                            layer.msg('旧密码输入错误！');
                        }
                    }
                });
                return false;
            });

            $(document).on('click', '#quit', function () {
                $("#init").hide();
                $("#delete_btn").hide();
                $('#username').html("普通用户");
                $("#login").show();
                $("#quit").hide();
                $("#tab4").hide();
                $("#btnn3").hide();
                sessionStorage.setItem("username", "");
                // layer.msg('退出登录成功!');
                top.location.href = '/#tab1=111';
                top.location.reload();
            });

        });
    </script>
</body>

</html>